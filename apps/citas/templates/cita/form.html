{% extends "main/dashboard.html" %} {% load i18n app_security %} {% load l10n humanize %} {% block content_title %}{% endblock content_title %} {% block content %}
{% load crispy_forms_tags %}
<style>
#external-events {
    float: left;
    width: 150px;
    padding: 0 10px;
    border: 1px solid #ccc;
    background: #eee;
    text-align: left;
}

#external-events h4 {
    font-size: 16px;
    margin-top: 0;
    padding-top: 1em;
}

#external-events .fc-event {
    margin: 10px 0;
    cursor: pointer;
}

#external-events p {
    margin: 1.5em 0;
    font-size: 11px;
    color: #666;
}

#external-events p input {
    margin: 0;
    vertical-align: middle;
}

#calendar {
    float: right;
    width: 900px;
}
</style>
<div class="container-overflow">
    <h4>Eventos Frecuentes</h4>
    <div id='external-events'>
    </div>
    <div id='calendar'></div>
</div>
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="myModalLabel">{{ title }}</h4>
            </div>
            <div class="modal-body">
                <form action="" method="post">
                    {% csrf_token %} {% crispy form %}
                </form>
            </div>
        </div>
    </div>
</div>
<script>
$(document).ready(function() {
    var todayDate = moment().startOf('day');
    var YM = todayDate.format('YYYY-MM');
    var YESTERDAY = todayDate.clone().subtract(1, 'day').format('YYYY-MM-DD');
    var TODAY = todayDate.format('YYYY-MM-DD');
    var TOMORROW = todayDate.clone().add(1, 'day').format('YYYY-MM-DD');
    $('#calendar').fullCalendar({
        locale: 'es',
        header: {
            left: 'prev,next today',
            center: 'title',
            // right: 'month,basicWeek,basicDay,listWeek'
            right: 'agendaDay,agendaWeek listDay,listWeek,listMonth,listYear',
            // right: 'month,agendaWeek,agendaDay,listWeek,listDay,listMonth,listYear,list',
        },
        defaultView: 'agendaWeek',
        buttonText: {
            today: 'Hoy',
            month: 'Mes',
            week: 'Semana',
            day: 'Día',
            listDay: 'Lista por dia',
            listWeek: 'Lista por semana',
            listMonth: 'Lista por mes',
            listYear: 'Lista por año',
        },
        // header: {
        //     left: '',
        //     center: 'prev title next',
        //     right: ''
        // },
        //defaultDate: '2016-01-12',
        editable: true,
        eventLimit: true, // allow "more" link when too many events
        selectable: true,
        //selectHelper: true,
        slotMinutes: 30,
        navLinks: true,
        allDaySlot: false, //para mostar en el calendario todo el dia
        scrollTime: '08:00:00',
        minTime: "08:00:00",
        maxTime: "18:00:00",
        weekends: false, //si incluye fin de semanas or //hiddenDays: [ 1, 3, 5 ]
        droppable: true, // this allows things to be dropped onto the calendar
        drop: function(date, data) {
            $('#myModal').modal('show');
            $("#id_evento").val(data.target.getAttribute("data-event"));
            $('#id_date').val(moment(date._d).format("YYYY-MM-DD HH:mm:ss"));
        },
        select: function(start, end) {
            $('#myModal').modal('show');
            $("#id_evento").val("");
            $('#id_date').val(moment(start).format("YYYY-MM-DD HH:mm:ss"));
            // var title = prompt('Event Title:');
            // var events;
            // if (title) {
            //     events = {
            //         title: title,
            //         start: start,
            //         end: end
            //     };
            //     $('#calendar').fullCalendar('renderEvent', events, true); // stick? = true
            // }
            // $('#calendar').fullCalendar('unselect');
        },
        events: function(start, end, timezone, callback) {
            // $.ajax({
            //     url: '/cita/listar/',
            //     dataType: 'json',
            //     type: 'get',
            //     success: function(doc) {
            //         var events = [];
            //         for (var i in doc) {
            //             events.push({
            //                 title: doc[i].fields.descripcion,
            //                 start: doc[i].fields.date,
            //             });
            //         }
            //         callback(events);
            //     },
            //     failure: function(data) {
            //         console.error('Ocurrió un problema al cargar.');
            //     }
            // });
            $.ajax({
                    url: '/cita/listar/',
                    type: 'get',
                    dataType: 'json',
                    //data: {param1: 'value1'},
                })
                .done(function(dat) {
                    console.log("success", dat);
                    var events = [];
                    for (var i in dat) {
                        dat[i].editable = false;
                        events.push(dat[i]);
                    }
                    callback(events);
                })
                .fail(function() {
                    console.log("error");
                })
                .always(function() {
                    console.log("complete");
                });

        },
        // events: [
        // {
        //     title: 'Conference',
        //     start: YESTERDAY,
        //     end: TOMORROW,
        //     color: 'yellow',
        //     textColor: 'red',
        //     backgroundColor: 'blue',
        //     borderColor: 'green',
        //     //editable:false,
        //     overlap: false, //If false, prevents this event from being dragged/resized over other events. ///EVITA la sobreposicion
        // },]

    });
    getEvents();

    function getEvents() {
        $.ajax({
                url: '/cita/eventos/listar/',
                type: 'get',
                dataType: 'json',
                //data: {param1: 'value1'},
            })
            .done(function(dat) {
                console.log("success", dat);
                var html = "";
                for (var i in dat) {
                    html = html +
                        "<div data-event='" + dat[i].pk + "'class='fc-event'>" +
                        dat[i].fields.title + "</div>";
                }
                $("#external-events").html(html);
                $('#external-events .fc-event').each(function() {

                    // store data so the calendar knows to render an event upon drop
                    $(this).data('event', {
                        title: $.trim($(this).text()), // use the element's text as the event title
                        stick: true // maintain when user navigates (see docs on the renderEvent method)
                    });

                    // make the event draggable using jQuery UI
                    $(this).draggable({
                        zIndex: 999,
                        revert: true, // will cause the event to go back to its
                        revertDuration: 0 //  original position after the drag
                    });
                });
            })
            .fail(function() {
                console.log("error");
            })
            .always(function() {
                console.log("complete");
            });
    }

});
</script>
{% endblock content %}
