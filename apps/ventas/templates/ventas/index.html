{% extends "main/dashboard.html" %} {% load i18n app_security %}{% load i18n crispy_forms_tags %} {% load l10n humanize %} {% block breadcrumbs %}
<a href="{# url 'accounts:index' #}">{% trans 'Home' %}</a> &rsaquo; {{ title }} {% endblock breadcrumbs %} {% block content_title %} {{ opts.verbose_name_plural|capfirst }} | <small>{{ title }}</small> {% endblock content_title %} {% block content %}
<div class="container-fluid  ">
    <div class="row panel panel-default">
        <div class="panel panel-info col-md-8">
            <div class="panel-heading row panel-titulo">
                <p class="titulo-busqueda"><span class="glyphicon glyphicon-shopping-cart btn-lg" aria-hidden="true"></span>Añadir productos o Servicios al Carrito</p>
                <div class="col-md-8 producto">
                    {{ form.producto }}
                </div>
                <div class="col-md-2 contenedor-cantidad-input">
                    <input type="number" name="cantidad" class="form-control cantidad-input" id="cantidad_producto">
                </div>
                <div>
                    <button id="enviar_producto" type="button" class="btn btn-md" aria-label="Left Align">Añadir al Carrito
                    </button>
                </div>
                <div class="col-md-2">
                </div>
            </div>
            <div class="panel-body ">
                <table class="table table-condensed">
                    <thead>
                        <tr>
                            <th class="text-center">Cantidad</th>
                            <th class="text-center">Descripcion</th>
                            <th class="text-center">Precio unitario</th>
                            <th class="text-center">Importe</th>
                            <th class="text-center">Opciones</th>
                        </tr>
                    </thead>
                    <tfoot>
                    </tfoot>
                    <tbody id="tabla_producto">
                    </tbody>
                </table>
            </div>
        </div>
        <div class="col-md-4 row">
            <form rule="" action="" method="post">{% csrf_token %}
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <p><span class="glyphicon glyphicon-user btn-lg" aria-hidden="true"></span>Seleccionar Cliente (Opcional)</p>
                        <div class="form-group">
                            <label class="sr-only" for="cliente"></label>
                            <div class="input-group">
                                <div class="input-group-btn">
                                    <button type="" class="btn btn-primary">Nuevo Cliente</button>
                                </div>
                                {{ form.cliente}}
                                <div class="input-group-addon"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></div>
                            </div>
                        </div>
                        
                    </div>
                    <div class="panel-body row text-center">
                        <p><span class="glyphicon glyphicon-shopping-cart btn-lg" aria-hidden="true"></span>Resumen de la Venta</p>
                        <div class="row">
                            <div class="col-md-6">
                                <p>Sub Total</p>
                            </div>
                            <div class="col-md-6">
                                <p>S/.<span id="r_sub_total">00.00</span></p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <p>IGV <span> 18% </span></p>
                            </div>
                            <div class="col-md-6">
                                <p>S/.<span id="r_igv">00.00</span></p>
                            </div>
                        </div>
                        <div class="row center-block">
                            <div class="col-md-6">
                                <p>Monto a pagar</p>
                            </div>
                            <div class="col-md-6">
                                <p>S/.<span id="r_total">00.00 </span></p>
                            </div>
                        </div>
                        <div class="row center-block">
                            <button id="btn_pagar" type="submit" name='form' class="btn btn-success col-md-12 btn-lg"> Pagar</button>
                        </div>
                    </div>
                </div>
                {{ form.data_venta}}
            </form>
        </div>
    </div>
</div>
<script type="text/javascript">
$(document).ready(function() {
    var stocks = new Bloodhound({
        limit: 5,
        datumTokenizer: Bloodhound.tokenizers.obj.whitespace('nombre'),
        queryTokenizer: Bloodhound.tokenizers.whitespace,
        //url:"{% url 'ventas:producto_s' %}"//'stockCodes.json',
        //remote: '/producto/search/',
        prefetch: '/producto/search/',
    });
    stocks.initialize();
    $('.typeahead ').typeahead(
        null, {
            minLength: 5,
            hint: true,
            highlight: true,
            displayKey: 'nombre',
            source: stocks.ttAdapter()
        }).on('typeahead:selected', function(event, data) {
        $('.typeahead').val(data.id);
        Venta.temp = data.id;
    });
});
$('#enviar_producto').attr('disabled', true);
$("#cantidad_producto").keyup(function() {
    $('#enviar_producto').attr('disabled', false);
});
(function() {
    function decimalAdjust(type, value, exp) {
        if (typeof exp === 'undefined' || +exp === 0) {
            return Math[type](value);
        }
        value = +value;
        exp = +exp;
        // Si el valor no es un número o el exp no es un entero...
        if (isNaN(value) || !(typeof exp === 'number' && exp % 1 === 0)) {
            return NaN;
        }
        // Shift
        value = value.toString().split('e');
        value = Math[type](+(value[0] + 'e' + (value[1] ? (+value[1] - exp) : -exp)));
        // Shift back
        value = value.toString().split('e');
        return +(value[0] + 'e' + (value[1] ? (+value[1] + exp) : exp));
    }
    // Decimal round
    if (!Math.round10) {
        Math.round10 = function(value, exp) {
            return decimalAdjust('round', value, exp);
        };
    }
    // Decimal floor
    if (!Math.floor10) {
        Math.floor10 = function(value, exp) {
            return decimalAdjust('floor', value, exp);
        };
    }
    // Decimal ceil
    if (!Math.ceil10) {
        Math.ceil10 = function(value, exp) {
            return decimalAdjust('ceil', value, exp);
        };
    }
})();
$(document).ready(function() {
    $("#enviar_producto").click(function() {
        function not_exist(dd) {
            for (var i in Venta.productos) {
                if (Venta.productos[i].id == dd) {
                    $('.typeahead').focus();
                    $('.typeahead , #cantidad_producto').val('');
                    $('#enviar_producto').attr('disabled', true);
                    console.log("ya existe en el carrto");
                    return false;
                    //mensaje error
                }
            }
            return true;
        }
        if ((not_exist(Venta.temp) && Venta.temp !== -1 && Venta.temp << 0)) {
            $.ajax({
                    url: "{% url 'ventas:carro' %}",
                    type: 'get',
                    data: {
                        p: Venta.temp
                    },
                })
                .done(function(data) {
                    var a;
                    if ($('#cantidad_producto').val() < 0) {
                        a = $('#cantidad_producto').val();
                        a = a * (-1);
                        data[0].fields.cantidad = a;
                        data[0].fields.importe = Math.ceil10((data[0].fields.precioV * data[0].fields.cantidad), -2);
                        data[0].fields.igvp = Math.ceil10((data[0].fields.precioV * data[0].fields.cantidad) * 0.18, -2);
                        data[0].fields.id = data[0].pk;
                        Venta.productos.push(data[0].fields);
                        $('#cantidad_producto').val("1");
                        Venta.igv = (Venta.igv + (data[0].fields.importe * 0.18));
                        Venta.total = Venta.total + data[0].fields.importe;
                        Venta.sub_total = Venta.total - Venta.igv;
                        draw();
                        $('#enviar_producto').attr('disabled', true);
                        $('.typeahead , #cantidad_producto').val('');
                        $('.typeahead').focus();
                    } else {
                        data[0].fields.cantidad = $('#cantidad_producto').val();
                        data[0].fields.importe = Math.ceil10(data[0].fields.precioV * data[0].fields.cantidad, -2);
                        data[0].fields.igvp = Math.ceil10((data[0].fields.precioV * data[0].fields.cantidad) * 0.18, -2);
                        data[0].fields.id = data[0].pk;
                        Venta.productos.push(data[0].fields);
                        $('#cantidad_producto').val("1");
                        Venta.igv = Math.ceil10((Venta.igv + (data[0].fields.importe * 0.18)), -2);
                        Venta.total = Math.ceil10(Venta.total + data[0].fields.importe, -2);
                        Venta.sub_total = Math.ceil10((Venta.total - Venta.igv), -2);
                        draw();
                        $('.typeahead , #cantidad_producto').val('');
                        $('#enviar_producto').attr('disabled', true);
                        $('.typeahead').focus();
                    }
                })
                .fail(function() {
                    console.log("error");
                })
                .always(function() {
                    console.log("complete");
                });
        }
    });
});
var Venta = {
    productos: [],
    igv: 0.00,
    sub_total: 0.00,
    total: 0.00,
    temp: -1
};

function draw() {
    $("#r_sub_total").text(Venta.sub_total);
    $("#r_igv").text(Venta.igv);
    $("#r_total").text(Venta.total);
    var h = "";
    for (var i in Venta.productos) {
        h = h + "<tr>" +
            "<td contenteditable='true' class='text-center' id='id" + i + "' onblur='change_p(" + i + ")'>" + Venta.productos[i].cantidad +
            "</td><td class='text-center'>" + Venta.productos[i].nombre +
            "</td><td class='text-center'>" + Venta.productos[i].precioV +
            "</td><td class='text-center'>" + Venta.productos[i].importe +
            "</td><td style='display:none;'class='col-hidden'>" + Venta.productos[i].igvp +
            "</td><td class='text-center'><button type='button' onclick='delete_p(" + i + ")'class='btn  btn-danger btn-md'><apan class='glyphicon glyphicon-trash'></span></button></td></tr>";
    }
    $("#tabla_producto").html(h);
    console.log(JSON.stringify(Venta));
    $("#id_data_venta").val(JSON.stringify(Venta));
}

function delete_p(d) {
    Venta.productos.splice(d, 1);
    Venta.total = 0.00;
    for (var i in Venta.productos) {
        Venta.total = Math.ceil10(Venta.total + Venta.productos[i].importe, -2);
    }
    Venta.igv = Math.ceil10(Venta.total * 0.18, -2);
    Venta.sub_total = Math.ceil10(Venta.total - Venta.igv, -2);
    draw();
    $('.typeahead , #cantidad_producto').val('');
}

function change_p(d) {
    Venta.productos[d].cantidad = $("#id" + d).text();
    Venta.productos[d].importe = Math.ceil10(Venta.productos[d].cantidad * Venta.productos[d].precioV, -2);
    Venta.productos[d].igvp = Math.ceil10((Venta.productos[d].cantidad * Venta.productos[d].precioV) * 0.18, -2);
    Venta.total = 0.00;
    for (var i in Venta.productos) {
        Venta.total = Math.ceil10(Venta.total + Venta.productos[i].importe, -2);
    }
    Venta.igv = Math.ceil10(Venta.total * 0.18, -2);
    Venta.sub_total = Math.ceil10(Venta.total - Venta.igv, -2);
    draw();
    $('.typeahead , #cantidad_producto').val('');
}
</script>
<!-- /#page-wrapper -->
{% endblock content %}
